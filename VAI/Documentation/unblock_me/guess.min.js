jQuery.fn.reverse = [].reverse;

var global_letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
var global_img_src = "assets/image/";
var global_current_level = 1;
var global_sound = true;
var global_render_data;
var global_level_array;
var global_score_level = "unblockme_level";
var global_level_color = "red";
var global_background_image = "bg_start1.jpg";


function createArray(length) {
    var arr = new Array(length || 0),
        i = length;

    if (arguments.length > 1) {
        var args = Array.prototype.slice.call(arguments, 1);
        while (i--) arr[length - 1 - i] = createArray.apply(this, args);
    }

    return arr;
}

$(document).ready(function () {

    global_current_level = scoreController.getLevel();

    pageController.renderLevels();
    pageController.chooseLevel(Math.min(scoreController.getLevel(), global_unblockme_data.length));

    ////todo
    getGameScore("Unblock Me", global_current_level, scoreController.setLevel);

    $('#buttonAudio').click(function (e) {
        if (global_sound) {
            global_sound = false;
            $('#buttonAudio span').removeClass('glyphicon glyphicon-volume-up');
            $('#buttonAudio span').addClass('glyphicon glyphicon-volume-off')
        }
        else {
            global_sound = true;
            $('#buttonAudio span').removeClass('glyphicon glyphicon-volume-off');
            $('#buttonAudio span').addClass('glyphicon glyphicon-volume-up')
        }
    });

    $('#buttonRefresh').click(function (e) {
        
        //scoreController.clearStatus();
        canvasController.init();

    });

    $('#buttonMenu').click(function (e) {
        $('#levelModal').modal("show");
    });

    window.onresize = function (e) {

        pageController.renderMessage("Page is reloading since windows size changed.");

        setTimeout(function () { $("#popupMessage").modal("hide"); location.reload();}, 2000);

    };

});

var soundController = (function () {

    var soundArray = [];
    preload();

    function preload() {
        soundArray.push({ type: "solved", audio: soundObject('assets/audio/solved.mp3') });
        soundArray.push({ type: "select", audio: soundObject('assets/audio/piece_select.mp3') });
        soundArray.push({ type: "move", audio: soundObject('assets/audio/piece_move.mp3') })
    }

    function soundObject(src) {
        var audio = new Audio();
        audio.src = src;
        audio.preload = "auto";

        return audio;
    }

    function play(type) {
        if (global_sound) {
            for (var i = 0; i < soundArray.length; i++) {
                if (soundArray[i].type == type) {
                    try {
                        soundArray[i].audio.play();
                    }
                    catch (e) { }
                    break;
                }
            }
        }
    }

    return {
        solved: function () { play('solved'); },
        select: function () { play('select'); },
        move: function () { play('move'); }
    };

}());

var scoreController = (function () {

    function getLevel() {
        return g$.store.getInt(global_score_level, 1);
    }

    function setLevel(level) {
        g$.store.set(global_score_level, level);
    }

    return {
        getLevel: getLevel,
        setLevel: setLevel
    };

}());

var pageController = (function () {

    function renderPopup(html)
    {
        $("#popupModal").remove();


        var customModal = $('<div class="modal" id="popupModal" tabindex="-1" role="dialog"><div class="modal-dialog"><div class="modal-content">' +
            '<div class="modal-body">' + '<div style="text-align:center;font-size:25px;font-weight:bold">' + html +
            '</div>' + '</div>' +
            '<div class="modal-footer"><button id="btnRestart" type="button" class="btn btn-danger">New Game</button>' +
            '</div></div></div></div>');


        $('body').append(customModal);

        function alignModal() {
            var modalDialog = $(this).find(".modal-dialog");

            // Applying the top margin on modal dialog to align it vertically center
            modalDialog.css("margin-top", Math.max(0, ($(window).height() - modalDialog.height()) / 2));
            //modalDialog.css("margin-top", Math.max(0, 550));
        }
        // Align modal when it is displayed
        $("#popupModal").on("shown.bs.modal", alignModal);

        // Align modal when user resize the window
        $(window).on("resize", function () {
            $(".modal:visible").each(alignModal);
        });

        $('#popupModal').modal({
            backdrop: 'static',
            keyboard: false
        });

        $("#popupModal").modal("show");
        
        //setTimeout(function (e) {$("#popupModal").modal("hide"); }, 2000);
        
        $('#btnRestart').click(function (e) {

            $("#popupModal").modal("hide");
            canvasController.init(e);

        });

    }

    function renderMessage(message) {
        $("#popupMessage").remove();


        var customModal = $('<div class="modal" data-keyboard="false" data-backdrop="false" id="popupMessage" tabindex="-1" role="dialog"><div class="modal-dialog"><div class="modal-content">' +
            '<div class="modal-body" style="background-color:gray;">' + '<div style="text-align:center;font-size:25px;font-weight:bold;color:white">' + message + '</div>' + '</div>' +
            '</div></div></div>');


        $('body').append(customModal);

        function alignModal() {
            var modalDialog = $(this).find(".modal-dialog");

            // Applying the top margin on modal dialog to align it vertically center
            modalDialog.css("margin-top", Math.max(0, ($(window).height() - modalDialog.height()) / 2));
            //modalDialog.css("margin-top", Math.max(0, 550));
        }
        // Align modal when it is displayed
        $("#popupMessage").on("shown.bs.modal", alignModal);

        // Align modal when user resize the window
        $(window).on("resize", function () {
            $(".modal:visible").each(alignModal);
        });

        $("#popupMessage").modal("show");

    }

    function renderLevels() {

        $("#levelModal").remove();

        var maxLevel = scoreController.getLevel();

        //maxLevel = 249;

        var buttonHtml = '';

        for (var i = 1; i <= global_unblockme_data.length; i++) {

            if (i < maxLevel) {
                buttonHtml += '<button type="button" class="btn btn-default" ' +
                ' style="width:70px;height:50px;margin:5px;position:relative" onclick="pageController.chooseLevel(this.textContent)"><span class="glyphicon glyphicon-check" style="position:absolute;top:0px;right:0px;color:green"></span>' + i + '</button>';
            }
            else if (i == maxLevel) {
                buttonHtml += '<button type="button" class="btn btn-default" ' +
                ' style="width:70px;height:50px;margin:5px;position:relative" onclick="pageController.chooseLevel(this.textContent)"><span class="" style="position:absolute;top:0px;right:0px;"></span>' + i + '</button>';
            }
            else {
                buttonHtml += '<button type="button" class="btn btn-default" ' +
                ' style="width:70px;height:50px;margin:5px;position:relative"><span class="glyphicon glyphicon-lock" style="position:absolute;top:0px;right:0px;color:red"></span>' + i + '</button>';
            }
        }

        var customModal = $('<div class="modal fade" id="levelModal" tabindex="-1" role="dialog"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal">&times;</button><h3 id="categoryHeader" class="modal-title">Choose Level</h3></div>' +
            '<div class="modal-body">' + '<div style="text-align:center;">' + buttonHtml + '</div>' + '</div>' +
            '<div class="modal-footer"><button id="btnReset" type="button" class="btn btn-danger">Reset Scores</button>' +
            '<button type="button" class="btn btn-default" data-dismiss="modal">Close</button></div></div></div></div>');


        $('body').append(customModal);

        $('#levelModal').on('show.bs.modal', function () {
            $('.modal .modal-body').css('overflow-y', 'scroll');
            $('.modal .modal-body').css('max-height', $(window).height() * 0.7);
        });

        $('#btnReset').on('click', function () {

            if (confirm("Reset Scores?")) {

                forceResetScore2("Unblock Me", 1, function () {
                    scoreController.setLevel(1);
                    location.reload();
                });
            }

        });
    }

    function chooseLevel(level) {
        global_current_level = parseInt(level) - 1;
        //global_current_level = 4;
        canvasController.init();

        $('#displayedLevel').html("Level: " + (global_current_level + 1));
        $('#score').html((global_current_level + 1) + "/" + global_unblockme_data.length);

        $('#levelModal').modal("hide");
    }

    return {
        renderPopup: renderPopup,
        renderMessage: renderMessage,
        renderLevels: renderLevels,
        chooseLevel: chooseLevel
    };

}());